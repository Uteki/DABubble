<section
  (click)="
    overlayActivated = false;
    channelOverlay = false;
    viewMemberOverlay = false;
    addMemberOverlay = false;
    profileOverlay = false;
  "
  class="overlay"
  [ngClass]="{ 'no-display': !overlayActivated }"
>
<div [ngClass]="{ 'no-display': !profileOverlay }" click-stop-propagation class="toggle-item">
    <div>
      <h2>Profil</h2>

      <button (click)="closeProfile()">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <mask
            id="mask0_153677_6137"
            style="mask-type: alpha"
            maskUnits="userSpaceOnUse"
            x="0"
            y="0"
            width="24"
            height="24"
          >
            <rect width="24" height="24" fill="#D9D9D9" />
          </mask>
          <g mask="url(#mask0_153677_6137)">
            <path
              d="M12 13.4L7.09999 18.3C6.91665 18.4833 6.68332 18.575 6.39999 18.575C6.11665 18.575 5.88332 18.4833 5.69999 18.3C5.51665 18.1167 5.42499 17.8833 5.42499 17.6C5.42499 17.3167 5.51665 17.0833 5.69999 16.9L10.6 12L5.69999 7.09999C5.51665 6.91665 5.42499 6.68332 5.42499 6.39999C5.42499 6.11665 5.51665 5.88332 5.69999 5.69999C5.88332 5.51665 6.11665 5.42499 6.39999 5.42499C6.68332 5.42499 6.91665 5.51665 7.09999 5.69999L12 10.6L16.9 5.69999C17.0833 5.51665 17.3167 5.42499 17.6 5.42499C17.8833 5.42499 18.1167 5.51665 18.3 5.69999C18.4833 5.88332 18.575 6.11665 18.575 6.39999C18.575 6.68332 18.4833 6.91665 18.3 7.09999L13.4 12L18.3 16.9C18.4833 17.0833 18.575 17.3167 18.575 17.6C18.575 17.8833 18.4833 18.1167 18.3 18.3C18.1167 18.4833 17.8833 18.575 17.6 18.575C17.3167 18.575 17.0833 18.4833 16.9 18.3L12 13.4Z"
              fill="black"
            />
          </g>
        </svg>
      </button>
    </div>
    <img [src]="getLargeAvatar(currentPartner?.avatar)" alt="" />

    <div class="profile-name">
      <h3>{{ currentPartner?.name ?? 'Anon' }}</h3>
    </div>

    <div class="profile-status">
      <img src="./../../../assets/img/active.svg" alt="" />
      <h3>Aktiv</h3>
    </div>

    <div class="profile-email">
      <div>
        <img src="./../../../assets/img/mail.svg" alt="" />
        <h3>E-Mail-Adresse</h3>
      </div>
      <a href="">{{ currentPartner?.email ??  'emre.iscan&#64;outlook.de' }}  </a>
    </div>

    <div (click)="emitPartner(currentPartner?.uid); closeProfile()" class="profile-direct-message">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <mask
          id="mask0_157535_8230"
          style="mask-type: alpha"
          maskUnits="userSpaceOnUse"
          x="0"
          y="0"
          width="24"
          height="24"
        >
          <rect width="24" height="24" fill="#D9D9D9" />
        </mask>
        <g mask="url(#mask0_157535_8230)">
          <path
            d="M20.3 20.3L18 18H4C3.45 18 2.97933 17.8043 2.588 17.413C2.196 17.021 2 16.55 2 16V4C2 3.45 2.196 2.979 2.588 2.587C2.97933 2.19567 3.45 2 4 2H20C20.55 2 21.021 2.19567 21.413 2.587C21.8043 2.979 22 3.45 22 4V19.575C22 20.025 21.796 20.3373 21.388 20.512C20.9793 20.6873 20.6167 20.6167 20.3 20.3ZM4 4V16H18.825L20 17.175V4H4Z"
            fill="white"
          />
        </g>
      </svg>

      <h3>Nachricht</h3>
    </div>
  </div>
</section>

<header>
  <div (click)="openProfile()">
  <img [src]="currentPartner?.avatar ?? 'assets/avatars/profile.png'" [alt]="currentPartner?.name ?? 'Anon'" />
    <h2>{{ currentPartner?.name ?? 'Anon' }}  @if(currentPartner?.uid === currentWhisperer) { (Du) }</h2>
  </div>
</header>

<output>
  <figure>
    <div>
      <img (click)="openProfile()" [src]="currentPartner?.avatar ?? 'assets/avatars/profile.png'" [alt]="currentPartner?.name ?? 'Anon'" />
      <p (click)="openProfile()">
        {{ currentPartner?.name ?? 'Anon' }}
      @if (currentPartner?.uid === currentWhisperer) { (Du) }
      </p>
    </div>
    @if (currentPartner == null || undefined) {
      <figcaption>Bitte klicke auf jemandem.</figcaption>
    } @else if (currentPartner?.uid !== currentWhisperer) {
      <figcaption>Diese Unterhaltung findet nur zwischen <a>&#64;{{ currentPartner?.name ?? 'Keinem' }}</a> und dir statt.</figcaption>
    }
    @else {
      <figcaption><b>Dieser Raum ist nur fÃ¼r dich da.</b> Mache dir Notizen, liste deine To-dos auf oder bewahre Links und Dateien griffbereit auf. Du kannst hier auch gerne Dinge mit dir selbst besprechen.</figcaption>
    }
  </figure>

  <!-- TODO ng if own messages when user -->
  <div *ngIf="messages.length > 0">
    <div
      *ngFor="let msg of messages; let i = index"
      class="message"
      [ngClass]="{ 'own-message': msg.uid === getUserId() }"
    >
      <div
        class="message-event"
        *ngIf="
          i === 0 ||
          (msg.timestamp | date : 'yyyy-MM-dd') !==
            (messages[i - 1].timestamp | date : 'yyyy-MM-dd')
        "
      >
        <div></div>
        <span class="timestamp">
          {{
            (msg.timestamp | date : "yyyy-MM-dd") ===
            (today | date : "yyyy-MM-dd")
              ? "Heute"
              : (msg.timestamp | date : "EEEE, d MMMM")
          }}
        </span>
        <div></div>
      </div>

      <div class="message-container">
        <img src="{{ getProfilePic(msg.uid) }}" alt="{{ msg.user }}" />
        <div>
          <div>
            <strong>{{ msg.user }}</strong>
            <span class="timestamp"
            >{{ msg.timestamp | date : "HH:mm" }} Uhr</span
            >
          </div>
          <div class="message-text">{{ msg.text }}</div>
             <app-reactions
            [reactions]="msg.reactions || {}"
            [currentUserId]="meId"
            [users]="users"
            [compact]="false"
            (toggled)="onReactionToggle(msg, $event)"
            (addedNew)="onReactionAdd(msg, $event)"
            [class.is-empty]="
              !(msg.reactions && Object.keys(msg.reactions).length > 0)
            "
          >
          </app-reactions>
        </div>
      </div>
    </div>
  </div>
</output>

<form
  aria-label="Nachricht senden"
  (submit)="sendMessage(); $event.preventDefault()"
>
  <label for="message"></label>
  <textarea
    id="message"
    name="message"
    placeholder="Nachricht an {{ currentPartner?.uid === currentWhisperer ? 'mich': currentPartner?.name }}"
    rows="2"
    [(ngModel)]="messageText"
  ></textarea>
    <button
    type="button"
    class="emoji-insert"
    (click)="showPicker = !showPicker"
    aria-label="Emoji einfÃ¼gen"
  >
    ðŸ˜Š
  </button>

  <div class="picker" *ngIf="showPicker" (mouseleave)="showPicker = false">
    <button
      *ngFor="
        let e of ['ðŸ˜€', 'ðŸ‘', 'ðŸŽ‰', 'â¤ï¸', 'ðŸ˜Š', 'ðŸ™', 'ðŸš€', 'ðŸ¤”', 'ðŸ˜…', 'ðŸ”¥']
      "
      type="button"
      (click)="insertEmojiIntoText(e); showPicker = false"
    >
      {{ e }}
    </button>
  </div>
  <button type="submit" aria-label="Nachricht senden">
    <svg
      width="23"
      height="20"
      viewBox="0 0 23 20"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M2.5 19.2812C2.08333 19.4479 1.6875 19.4112 1.3125 19.1712C0.9375 18.9321 0.75 18.5833 0.75 18.125V13.4687C0.75 13.1771 0.833333 12.9167 1 12.6875C1.16667 12.4583 1.39583 12.3125 1.6875 12.25L10.75 9.99999L1.6875 7.74999C1.39583 7.68749 1.16667 7.54166 1 7.31249C0.833333 7.08333 0.75 6.82291 0.75 6.53124V1.87499C0.75 1.41666 0.9375 1.06749 1.3125 0.827493C1.6875 0.588327 2.08333 0.552076 2.5 0.718743L21.75 8.84374C22.2708 9.07291 22.5312 9.45833 22.5312 9.99999C22.5312 10.5417 22.2708 10.9271 21.75 11.1562L2.5 19.2812Z"
        fill="#444DF2"
      />
    </svg>
  </button>
</form>
