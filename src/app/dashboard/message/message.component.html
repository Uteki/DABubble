<section
  (click)="
    overlayActivated = false;
    channelOverlay = false;
    viewMemberOverlay = false;
    addMemberOverlay = false
  "
  class="overlay"
  [ngClass]="{ 'no-display': !overlayActivated }"
></section>

<header>
  <div>
    <img
      [src]="currentPartner?.avatar ?? 'assets/avatars/profile.png'"
      [alt]="currentPartner?.name ?? 'Anon'"
    />
    <h2>{{ currentPartner?.name ?? "Anon" }}</h2>
  </div>
</header>

<output>
  <figure>
    <div>
      <img
        [src]="currentPartner?.avatar ?? 'assets/avatars/profile.png'"
        [alt]="currentPartner?.name ?? 'Anon'"
      />
      <p>
        {{ currentPartner?.name ?? "Anon" }}
        @if (currentPartner?.uid === currentWhisperer) { (Du) }
      </p>
    </div>
    @if (currentPartner == null || undefined) {
    <figcaption>Bitte klicke auf jemandem.</figcaption>
    } @else if (currentPartner?.uid !== currentWhisperer) {
    <figcaption>
      Diese Unterhaltung findet nur zwischen
      <a>&#64;{{ currentPartner?.name ?? "Keinem" }}</a> und dir statt.
    </figcaption>
    } @else {
    <figcaption>
      <b>Dieser Raum ist nur fÃ¼r dich da.</b> Mache dir Notizen, liste deine
      To-dos auf oder bewahre Links und Dateien griffbereit auf. Du kannst hier
      auch gerne Dinge mit dir selbst besprechen.
    </figcaption>
    }
  </figure>

  <!-- TODO ng if own messages when user -->
  <div *ngIf="messages.length > 0">
    <div
      *ngFor="let msg of messages; let i = index"
      class="message"
      [ngClass]="{ 'own-message': msg.uid === getUserId() }"
    >
      <div
        class="message-event"
        *ngIf="
          i === 0 ||
          (msg.timestamp | date : 'yyyy-MM-dd') !==
            (messages[i - 1].timestamp | date : 'yyyy-MM-dd')
        "
      >
        <div></div>
        <span class="timestamp">
          {{
            (msg.timestamp | date : "yyyy-MM-dd") ===
            (today | date : "yyyy-MM-dd")
              ? "Heute"
              : (msg.timestamp | date : "EEEE, d MMMM")
          }}
        </span>
        <div></div>
      </div>

      <div class="message-container">
        <img src="{{ getProfilePic(msg.uid) }}" alt="{{ msg.user }}" />
        <div>
          <div>
            <strong>{{ msg.user }}</strong>
            <span class="timestamp"
              >{{ msg.timestamp | date : "HH:mm" }} Uhr</span
            >
          </div>
          <div class="message-text">{{ msg.text }}</div>
             <app-reactions
            [reactions]="msg.reactions || {}"
            [currentUserId]="meId"
            [users]="users"
            [compact]="false"
            (toggled)="onReactionToggle(msg, $event)"
            (addedNew)="onReactionAdd(msg, $event)"
            [class.is-empty]="
              !(msg.reactions && Object.keys(msg.reactions).length > 0)
            "
          >
          </app-reactions>
        </div>
      </div>
    </div>
  </div>
</output>

<form
  aria-label="Nachricht senden"
  (submit)="sendMessage(); $event.preventDefault()"
>
  <label for="message"></label>
  <textarea
    id="message"
    name="message"
    placeholder="Nachricht an {{
      currentPartner?.uid === currentWhisperer ? 'mich' : currentPartner?.name
    }}"
    rows="2"
    [(ngModel)]="messageText"
  ></textarea>
    <button
    type="button"
    class="emoji-insert"
    (click)="showPicker = !showPicker"
    aria-label="Emoji einfÃ¼gen"
  >
    ğŸ˜Š
  </button>

  <div class="picker" *ngIf="showPicker" (mouseleave)="showPicker = false">
    <button
      *ngFor="
        let e of ['ğŸ˜€', 'ğŸ‘', 'ğŸ‰', 'â¤ï¸', 'ğŸ˜Š', 'ğŸ™', 'ğŸš€', 'ğŸ¤”', 'ğŸ˜…', 'ğŸ”¥']
      "
      type="button"
      (click)="insertEmojiIntoText(e); showPicker = false"
    >
      {{ e }}
    </button>
  </div>
  <button type="submit" aria-label="Nachricht senden">
    <svg
      width="23"
      height="20"
      viewBox="0 0 23 20"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M2.5 19.2812C2.08333 19.4479 1.6875 19.4112 1.3125 19.1712C0.9375 18.9321 0.75 18.5833 0.75 18.125V13.4687C0.75 13.1771 0.833333 12.9167 1 12.6875C1.16667 12.4583 1.39583 12.3125 1.6875 12.25L10.75 9.99999L1.6875 7.74999C1.39583 7.68749 1.16667 7.54166 1 7.31249C0.833333 7.08333 0.75 6.82291 0.75 6.53124V1.87499C0.75 1.41666 0.9375 1.06749 1.3125 0.827493C1.6875 0.588327 2.08333 0.552076 2.5 0.718743L21.75 8.84374C22.2708 9.07291 22.5312 9.45833 22.5312 9.99999C22.5312 10.5417 22.2708 10.9271 21.75 11.1562L2.5 19.2812Z"
        fill="#444DF2"
      />
    </svg>
  </button>
</form>
