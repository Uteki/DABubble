<section
  (click)="
    overlayActivated = false;
    channelOverlay = false;
    viewMemberOverlay = false;
    addMemberOverlay = false;
    profileOverlay = false
  "
  class="overlay"
  [ngClass]="{ 'no-display': !overlayActivated }"
>
  <div
    [ngClass]="{ 'no-display': !profileOverlay }"
    click-stop-propagation
    class="toggle-item"
  >
    <div>
      <h2>Profil</h2>

      <button (click)="closeProfile()">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <mask
            id="mask0_153677_6137"
            style="mask-type: alpha"
            maskUnits="userSpaceOnUse"
            x="0"
            y="0"
            width="24"
            height="24"
          >
            <rect width="24" height="24" fill="#D9D9D9" />
          </mask>
          <g mask="url(#mask0_153677_6137)">
            <path
              d="M12 13.4L7.09999 18.3C6.91665 18.4833 6.68332 18.575 6.39999 18.575C6.11665 18.575 5.88332 18.4833 5.69999 18.3C5.51665 18.1167 5.42499 17.8833 5.42499 17.6C5.42499 17.3167 5.51665 17.0833 5.69999 16.9L10.6 12L5.69999 7.09999C5.51665 6.91665 5.42499 6.68332 5.42499 6.39999C5.42499 6.11665 5.51665 5.88332 5.69999 5.69999C5.88332 5.51665 6.11665 5.42499 6.39999 5.42499C6.68332 5.42499 6.91665 5.51665 7.09999 5.69999L12 10.6L16.9 5.69999C17.0833 5.51665 17.3167 5.42499 17.6 5.42499C17.8833 5.42499 18.1167 5.51665 18.3 5.69999C18.4833 5.88332 18.575 6.11665 18.575 6.39999C18.575 6.68332 18.4833 6.91665 18.3 7.09999L13.4 12L18.3 16.9C18.4833 17.0833 18.575 17.3167 18.575 17.6C18.575 17.8833 18.4833 18.1167 18.3 18.3C18.1167 18.4833 17.8833 18.575 17.6 18.575C17.3167 18.575 17.0833 18.4833 16.9 18.3L12 13.4Z"
              fill="black"
            />
          </g>
        </svg>
      </button>
    </div>
    <img [src]="getLargeAvatar(currentPartner?.avatar)" alt="" />

    <div class="profile-name">
      <h3>{{ currentPartner?.name ?? "Anon" }}</h3>
    </div>

    <div class="profile-status">
      <img src="../../../../assets/img/active.svg" alt="" />
      <h3>Aktiv</h3>
    </div>

    <div class="profile-email">
      <div>
        <img src="../../../../assets/img/mail.svg" alt="" />
        <h3>E-Mail-Adresse</h3>
      </div>
      <a href="">{{ currentPartner?.email ?? "emre.iscan&#64;outlook.de" }} </a>
    </div>

    <div
      (click)="emitPartner(currentPartner?.uid); closeProfile()"
      class="profile-direct-message"
    >
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <mask
          id="mask0_157535_8230"
          style="mask-type: alpha"
          maskUnits="userSpaceOnUse"
          x="0"
          y="0"
          width="24"
          height="24"
        >
          <rect width="24" height="24" fill="#D9D9D9" />
        </mask>
        <g mask="url(#mask0_157535_8230)">
          <path
            d="M20.3 20.3L18 18H4C3.45 18 2.97933 17.8043 2.588 17.413C2.196 17.021 2 16.55 2 16V4C2 3.45 2.196 2.979 2.588 2.587C2.97933 2.19567 3.45 2 4 2H20C20.55 2 21.021 2.19567 21.413 2.587C21.8043 2.979 22 3.45 22 4V19.575C22 20.025 21.796 20.3373 21.388 20.512C20.9793 20.6873 20.6167 20.6167 20.3 20.3ZM4 4V16H18.825L20 17.175V4H4Z"
            fill="white"
          />
        </g>
      </svg>

      <h3>Nachricht</h3>
    </div>
  </div>
</section>

<header>
  <div (click)="openProfile()">
    <figure>
      <img
        [src]="currentPartner?.avatar ?? 'assets/avatars/profile.png'"
        [alt]="currentPartner?.name ?? 'Anon'"
      />
      @if (currentPartner?.status) {
        <img src="../../../../assets/img/online.png" alt="" />
      } @else {
        <img src="../../../../assets/img/offline.svg" alt="" />
      }
    </figure>
    <h2>
      {{ currentPartner?.name ?? "Anon" }} @if(currentPartner?.uid ===
      currentWhisperer) { (Du) }
    </h2>
  </div>
</header>

<output chat-scroll [messages]="messages">
  <figure>
    <div>
      <img
        (click)="openProfile()"
        [src]="currentPartner?.avatar ?? 'assets/avatars/profile.png'"
        [alt]="currentPartner?.name ?? 'Anon'"
      />
      <p (click)="openProfile()">
        {{ currentPartner?.name ?? "Anon" }}
        @if (currentPartner?.uid === currentWhisperer) { (Du) }
      </p>
    </div>
    @if (currentPartner == null || undefined) {
    <figcaption>Bitte klicke auf jemandem.</figcaption>
    } @else if (currentPartner?.uid !== currentWhisperer) {
    <figcaption>
      Diese Unterhaltung findet nur zwischen
      <a>&#64;{{ currentPartner?.name ?? "Keinem" }}</a> und dir statt.
    </figcaption>
    } @else {
    <figcaption>
      <b>Dieser Raum ist nur fÃ¼r dich da.</b> Mache dir Notizen, liste deine
      To-dos auf oder bewahre Links und Dateien griffbereit auf. Du kannst hier
      auch gerne Dinge mit dir selbst besprechen.
    </figcaption>
    }
  </figure>

  <!-- TODO ng if own messages when user -->
  <div *ngIf="messages.length > 0">
    <div
      *ngFor="let msg of messages; let i = index"
      class="message"
      [ngClass]="{
        'own-message': msg.uid === getUserId(),
        'edit-message': editMessageIsOpen && editingMessageId === msg.id,
        'not-edit-message': !editMessageIsOpen
      }"
      (mouseover)="hoverMessage(msg.id, msg.uid, $event)"
      (mouseleave)="leaveMessage(msg.id); editMessageMenuOpen = null"
    >
      <div
        class="message-event"
        *ngIf="
          i === 0 ||
          (msg.timestamp | date : 'yyyy-MM-dd') !==
            (messages[i - 1].timestamp | date : 'yyyy-MM-dd')
        "
      >
        <div></div>
        <span class="timestamp">
          {{
            (msg.timestamp | date : "yyyy-MM-dd") ===
            (today | date : "yyyy-MM-dd")
              ? "Heute"
              : (msg.timestamp | date : "EEEE, d MMMM")
          }}
        </span>
        <div></div>
      </div>

      <div
        class="message-container"
        [ngClass]="{
          'edit-mode-width': editMessageIsOpen && editingMessageId === msg.id
        }"
      >
        <img src="{{ getProfilePic(msg.uid) }}" alt="{{ msg.user }}" />
        <div
          [ngClass]="{
            'edit-mode-width': editMessageIsOpen && editingMessageId === msg.id
          }"
        >
          <div>
            <strong>{{ msg.user }}</strong>
            <span
              class="timestamp"
              [ngClass]="{
                'no-display': editMessageIsOpen && editingMessageId === msg.id
              }"
              >{{ msg.timestamp | date : "HH:mm" }} Uhr</span
            >
          </div>

          @if (editingMessageId === msg.id) {
          <!-- Edit Mode -->
          <div
            class="message-edit-bubble"
            [ngClass]="{
              'edit-mode-bubble':
                editMessageIsOpen && editingMessageId === msg.id,
              'edit-mode-width':
                editMessageIsOpen && editingMessageId === msg.id
            }"
          >
            <textarea
              [(ngModel)]="editingMessageText"
              rows="3"
              class="message-edit-textarea"
            ></textarea>
            <div class="message-edit-actions">
              <div class="button-group">
                <button
                  type="button"
                  (click)="cancelEdit()"
                  class="btn-secondary"
                >
                  Abbrechen
                </button>
                <button
                  type="button"
                  (click)="saveEditedMessage(msg.id)"
                  class="btn-primary"
                >
                  Speichern
                </button>
              </div>
            </div>
          </div>
          } @else {
          <div
            [attr.data-message-id]="msg.id"
            [innerHTML]="msg.text | linkify:users:channels"
            id="message-text-{{ msg.id }}" class="message-text" >
          </div>
          <app-reactions
            [reactions]="msg.reactions || {}"
            [currentUserId]="meId"
            [users]="users"
            [compact]="false"
            [externalPickerOpen]="showReactionPicker[msg.id] || false"
            [(externalPickerOpen)]="showReactionPicker[msg.id]"
            (toggled)="onReactionToggle(msg, $event)"
            (addedNew)="onReactionAdd(msg, $event)"
            [class.is-empty]="
              !(msg.reactions && Object.keys(msg.reactions).length > 0)
            "
          >
          </app-reactions>
          }
        </div>
      </div>
      <div
        class="message-actions-container"
        [ngClass]="{
          'no-message-event':
            i !== 0 &&
            (msg.timestamp | date : 'yyyy-MM-dd') ===
              (messages[i - 1].timestamp | date : 'yyyy-MM-dd')
        }"
      >
        <div
          class="comment-hover-overlay"
          [id]="'comment-hover-' + msg.id"
          [ngClass]="{
            'no-display': editMessageIsOpen && editingMessageId === msg.id
          }"
        >
          <div (click)="addEmojiToMessageField('âœ“', msg.id)">
            <img src="./assets/img/checkMark.svg" alt="" />
          </div>
          <div (click)="addEmojiToMessageField('ðŸ‘', msg.id)">
            <img src="./assets/img/capa.svg" alt="" />
          </div>
          <div (click)="openReactionPicker(msg.id)">
            <img src="./assets/icons/reactions/addReaction.png" alt="" />
          </div>
          <div
            [ngClass]="{ 'no-display': msg.uid !== getUserId() }"
            class="more-vert-button"
            (click)="toggleEditMessageMenu(msg.id, $event)"
          >
            <img src="./assets/icons/svgs/moreVert.svg" alt="" />
          </div>
        </div>
        <div
          class="edit-message-menu"
          [class.visible]="editMessageMenuOpen === msg.id"
        >
          <div (click)="editMessage(msg.id)">Nachricht bearbeiten</div>
        </div>
      </div>
    </div>
  </div>
</output>

<form
  aria-label="Nachricht senden"
  (submit)="sendMessage(); $event.preventDefault()"
>
  <label for="message"></label>
  <div id="search-chat-channels2" class="text-channel-list no-display">
    <ng-container *ngFor="let channel of filteredChannels">
      <div
        (click)="insertMention(channel.name, messageInput)"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <mask
            id="mask0_157289_4664"
            style="mask-type: alpha"
            maskUnits="userSpaceOnUse"
            x="0"
            y="0"
            width="24"
            height="24"
          >
            <rect width="24" height="24" fill="#D9D9D9" />
          </mask>
          <g mask="url(#mask0_157289_4664)">
            <path
              d="M7.22504 20.325C6.7917 20.325 6.45004 20.1623 6.20004 19.837C5.95004 19.5123 5.87504 19.1417 5.97504 18.725L6.57504 16.325H4.77504C4.34171 16.325 3.9917 16.1583 3.72504 15.825C3.45837 15.4917 3.38337 15.1083 3.50004 14.675C3.58337 14.3917 3.7417 14.154 3.97504 13.962C4.20837 13.7707 4.47504 13.675 4.77504 13.675H7.25004L8.07504 10.325H5.77504C5.3417 10.325 4.9917 10.1583 4.72504 9.82499C4.45837 9.49165 4.38337 9.10832 4.50004 8.67499C4.58337 8.39165 4.7417 8.15432 4.97504 7.96299C5.20837 7.77099 5.47504 7.67499 5.77504 7.67499H8.75004L9.50004 4.64999C9.58337 4.36665 9.74171 4.13332 9.97504 3.94999C10.2084 3.76665 10.475 3.67499 10.775 3.67499C11.2084 3.67499 11.55 3.83732 11.8 4.16199C12.05 4.48732 12.125 4.85832 12.025 5.27499L11.425 7.67499H14.75L15.5 4.64999C15.5834 4.36665 15.7417 4.13332 15.975 3.94999C16.2084 3.76665 16.475 3.67499 16.775 3.67499C17.2084 3.67499 17.55 3.83732 17.8 4.16199C18.05 4.48732 18.125 4.85832 18.025 5.27499L17.425 7.67499H19.225C19.6584 7.67499 20.0084 7.84165 20.275 8.17499C20.5417 8.50832 20.6167 8.89165 20.5 9.32499C20.4167 9.60832 20.2584 9.84565 20.025 10.037C19.7917 10.229 19.525 10.325 19.225 10.325H16.75L15.925 13.675H18.225C18.6584 13.675 19.0084 13.8417 19.275 14.175C19.5417 14.5083 19.6167 14.8917 19.5 15.325C19.4167 15.6083 19.2584 15.846 19.025 16.038C18.7917 16.2293 18.525 16.325 18.225 16.325H15.25L14.5 19.35C14.4167 19.6333 14.2584 19.8667 14.025 20.05C13.7917 20.2333 13.525 20.325 13.225 20.325C12.7917 20.325 12.45 20.1623 12.2 19.837C11.95 19.5123 11.875 19.1417 11.975 18.725L12.575 16.325H9.25004L8.50004 19.35C8.4167 19.6333 8.25837 19.8667 8.02504 20.05C7.7917 20.2333 7.52504 20.325 7.22504 20.325ZM9.92504 13.675H13.25L14.075 10.325H10.75L9.92504 13.675Z"
              fill="black"
            />
          </g>
        </svg>

        <h3>
          {{ channel.name.charAt(0).toUpperCase() + channel.name.slice(1) }}
        </h3>
      </div>
    </ng-container>
  </div>
  <div id="search-chat-members2" class="text-member-list no-display">
    <ng-container *ngFor="let user of filteredUsers">
      <div
        *ngIf="user.name"
        (click)="insertMention(user.name, messageInput)"
      >
        <article>
          <figure class="user-avatar">
            <img [src]="user.avatar" [alt]="user.name" />

            @if (user.status) {
              <img src="../../../../assets/img/online.png" alt="" />
            } @else {
              <img src="../../../../assets/img/offline.svg" alt="" />
            }
          </figure>

          <p>{{ user.name }}</p>
        </article>
      </div>
    </ng-container>
  </div>
  <textarea
    #messageInput
    (input)="onInputChange($any($event.target).value)"
    id="message"
    name="message"
    placeholder="Nachricht an {{
      currentPartner?.uid === currentWhisperer ? 'mich' : currentPartner?.name
    }}"
    rows="2"
    (keydown.enter)="$event.preventDefault(); sendMessage()"
    [(ngModel)]="messageText"
  ></textarea>
  <button
    type="button"
    class="emoji-insert"
    (click)="showPicker = !showPicker"
    aria-label="Emoji einfÃ¼gen"
  >
    ðŸ˜Š
  </button>

  <div class="picker" *ngIf="showPicker" (mouseleave)="showPicker = false">
    <button
      *ngFor="
        let e of ['ðŸ˜€', 'ðŸ‘', 'ðŸŽ‰', 'â¤ï¸', 'ðŸ˜Š', 'ðŸ™', 'ðŸš€', 'ðŸ¤”', 'ðŸ˜…', 'ðŸ”¥']
      "
      type="button"
      (click)="insertEmojiIntoText(e); showPicker = false"
    >
      {{ e }}
    </button>
  </div>
  <button type="submit" aria-label="Nachricht senden">
    <svg
      width="23"
      height="20"
      viewBox="0 0 23 20"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M2.5 19.2812C2.08333 19.4479 1.6875 19.4112 1.3125 19.1712C0.9375 18.9321 0.75 18.5833 0.75 18.125V13.4687C0.75 13.1771 0.833333 12.9167 1 12.6875C1.16667 12.4583 1.39583 12.3125 1.6875 12.25L10.75 9.99999L1.6875 7.74999C1.39583 7.68749 1.16667 7.54166 1 7.31249C0.833333 7.08333 0.75 6.82291 0.75 6.53124V1.87499C0.75 1.41666 0.9375 1.06749 1.3125 0.827493C1.6875 0.588327 2.08333 0.552076 2.5 0.718743L21.75 8.84374C22.2708 9.07291 22.5312 9.45833 22.5312 9.99999C22.5312 10.5417 22.2708 10.9271 21.75 11.1562L2.5 19.2812Z"
        fill="#444DF2"
      />
    </svg>
  </button>
</form>
